<!doctype html>
<html>
  <head>
    <title>Simple Tiles</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<!--
+-----------------------------+
|^^^^                      / ~|
|^^^            ----------   /|
|^^   Simple  /    ---------  |
|            / ~ / **         |
|           /   / ****        |
|      ----  ~ / ******       |
|     / ~~  -- *******        |
|    /    /    *****          |
|   /    /                    |
|  / ~~ /       Tiles   ^^^^ ^|
|-     /                ^^^ ^^|
| ~~~ /                 ^^ ^^^|
+-----------------------------+

documentation layout inspired by backbone and underscore, obvs
-->
    <style>
      /* reset */
      div, html, body {
        margin: 0;
        padding: 0;
        border: 0;
        vertical-align: baseline;
      }

      ul { list-style: none; padding-left: 10px;}
      li { margin-bottom: 1em; }
      /* text styles */
      body {
        font-family: "Helvetica Nueue", Helvetica, sans-serif;
        font-size: 14px;
        line-height: 1.7em;
        margin-left: 220px;
        padding: 20px;
      }
      p, li {
        width: 600px;
        margin: 0px 0px 1em;
      }

      h1, h2, h3 {
        text-rendering: optimizeLegibility;
        margin-left: -5px;
      }

      h4 {
        margin: 0px;
        margin-top: 30px;
        margin-left: -5px;
        font-weight: normal;
      }

      h4 code {
        padding: 4px;
        background-color: #e6f3ff;
      }

      code, pre, tt { font-family: Monaco, monospace; font-size: 12px; }
      tt { border:1px solid #cdcdcd; padding: 2px;}
      a { color: black; }
      a:hover { text-decoration: none; }
      pre {
        padding-left: 10px;
        font-size: 12px;
        border-left: 5px solid #efefef;
      }

      hr {
        border: 0;
        border-top: 1px solid #efefef;
        height: 1px;
      }

      /* layout */
      #sidebar {
        top:0;
        left:0;
        bottom:0;
        position:fixed;
        padding: 20px;
        width: 180px;
        border-right: 1px solid #efefef;
      }

      #sidebar a { font-weight: bold; }

      #sidebar li a {
        font-weight: normal;
        text-decoration:none;
      }

      #sidebar li a:hover { text-decoration: underline; }

      #sidebar li {
        font-size: 12px;
        margin-left: 5px;
        margin-bottom: 0;
      }

      #sidebar h4 { margin: 0.7em 0;}

      /* lion-roar scrolling */
      #sidebar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
        z-index: 999;
      }

      #sidebar::-webkit-scrollbar-button:start:decrement,
      #sidebar::-webkit-scrollbar-button:end:increment {
        display: block;
        height:3px;
      }

      #sidebar::-webkit-scrollbar-thumb:vertical {
        height: 20px;
        background-color: rgba(0,0,0,0.3);
        -webkit-border-radius: 5px;
        -webkit-box-shadow: 0 1px 1px rgba(255,255,255,0.9);
        padding-right:0px;
      }

      #sidebar::-webkit-scrollbar-track:enabled {
        background-color: transparent;
        width:10px;
      }

      #sidebar::-webkit-scrollbar-track-piece {
        background-color: transparent;
        border: none;
        margin: 0 5px 0px 0;
      }

      :target code {
        background-color: #d8f7ee;
        border: 1px solid #ababab;
      }
    </style>
  </head>

  <body>
    <div id="sidebar">
      <h4><a href="#dependencies">Dependencies</a></h4>
      <h4><a href="#installation">Installation</a></h4>
      <h4><a href="#compilation">Compilation & Linking</a></h4>
      <h4><a href="#overview">Overview</a></h4>
      <hr>
      <h4><a href="#maps">Maps</a></h4>
      <ul>
        <li><a href="#simplet_map_new">simplet_map_new</a></li>
        <li><a href="#simplet_map_free">simplet_map_free</a></li>
        <li><a href="#simplet_map_set_srs">simplet_map_set_srs</a></li>
        <li><a href="#simplet_map_get_srs">simplet_map_get_srs</a></li>
        <li><a href="#simplet_map_set_size">simplet_map_set_size</a></li>
        <li><a href="#simplet_map_set_bounds">simplet_map_set_bounds</a></li>
        <li><a href="#simplet_map_set_slippy">simplet_map_set_slippy</a></li>
        <li><a href="#simplet_map_set_bgcolor">simplet_map_set_bgcolor</a></li>
        <li><a href="#simplet_map_get_bgcolor">simplet_map_get_bgcolor</a></li>
        <li><a href="#simplet_map_add_layer">simplet_map_add_layer</a></li>
        <li><a href="#simplet_map_add_layer_directly">simplet_map_add_layer_directly</a></li>
        <li><a href="#simplet_map_get_status">simplet_map_get_status</a></li>
        <li><a href="#simplet_map_status_to_string">simplet_map_status_to_string</a></li>
        <li><a href="#simplet_map_is_valid">simplet_map_is_valid</a></li>
        <li><a href="#simplet_map_render_to_png">simplet_map_render_to_png</a></li>
        <li><a href="#simplet_map_render_to_stream">simplet_map_render_to_stream</a></li>
        <li><a href="#simplet_map_set_buffer">simplet_map_set_buffer</a></li>
        <li><a href="#simplet_map_get_buffer">simplet_map_get_buffer</a></li>
      </ul>
      <hr>
      <h4><a href="#layers">Layers</a></h4>
      <ul>
        <li><a href="#simplet_layer_new">simplet_layer_new</a></li>
        <li><a href="#simplet_layer_free">simplet_layer_free</a></li>
        <li><a href="#simplet_layer_set_source">simplet_set_source</a></li>
        <li><a href="#simplet_layer_get_source">simplet_get_source</a></li>
      </ul>
      <hr>
      <h4><a href="#filters">Filters</a></h4>
      <hr>
      <h4><a href="#styles">Styles</a></h4>
    </div>
    <img src="docs/simple-tiles-logo.png">
    <p><a href="http://github.com/propublica/simple-tiles">Simple Tiles</a>
    is an image generation library for spatial data written in C. At it's
    core it is a thin wrapper on top of <a href="http://www.gdal.org/ogr">OGR</a>
    for spatial data and <a href="http://cairographics.org">Cairo</a>
    for image generation.</p>

    <p>The library's source is over at <a href="http://github.com/propublica/simple-tiles">github</a>
    and there is an <a href="docs/map.html">annotated version</a> available. Please report
    issues or ask questions in the
    <a href="https://github.com/propublica/simple-tiles/issues">issue tracker</a>,
    or head on over to <tt>#newsapps</tt> or <tt>#propublica</tt> on Freenode IRC.</p>

    <p>There are currently Ruby bindings in
    <a href="http://github.com/propublica/simpler-tiles">Simpler Tiles</a>.</p>

    <h2 id="dependencies">Dependencies</h2>
    <p>Simple Tiles relies on GDAL and OGR for abstractions over geospatial data. You'll
    need at least version 1.8.0 to use the library. On Ubuntu you can install
    the library using the <a href="https://launchpad.net/~ubuntugis/+archive/ppa/">ubuntugis ppa</a>.
    On OS X the version from homebrew works well.
    </p>

    <p>Simple Tiles uses <a href="http://cairographics.org">Cairo</a> and
    <a href="http://developer.gnome.org/pango/stable/">Pango</a>  for the final
    png output, you'll need an installed and working version of both. On Ubuntu
    apt-get installs a perfectly fine version of both, and OS X users can use homebrew.
    </p>

    <h2 id="installation">Installation</h2>
    <p>To install Simple Tiles run:</p>
<pre>
$ git clone git@github.com:propublica/simple-tiles.git
$ cd simple-tiles
$ make && make install
</pre>
    <p>You'll probably also want to run:</p>
<pre>
$ make test
</pre>
    <p>to ensure the library and its dependencies are playing nice with one another.</p>

    <h2 id="compilation">Compilation and Linking</h2>
    <p>Once you have a working copy of Simple Tiles, you'll want to use <b>pkg-config</b>
    to link to the library. For example, to compile a file with Simple Tiles use:</p>
<pre>
cc `pkg-config --cflags simple-tiles` `gdal-config --cflags` -c -o main.o main.c
cc main.o `pkg-config --libs simple-tiles` `gdal-config --libs` -o main
</pre>
    <p>And your program should be linked correctly.</p>

    <h2 id="overview">Overview</h2>
    <p>Simple Tiles is written in an object oriented fashion with thin data structures.
      The heirarchy of <a href="docs/types_h.html">structures</a> consists of:</p>
    <ul>
      <li>
        <tt>simplet_map_t</tt>: Each <tt>simplet_map_t</tt> stores the projection,
        bounds, the width and height of the desired image, and a list of
        <tt>simplet_layer_t</tt> instances.
      </li>
      <li>
        <tt>simplet_layer_t</tt>: Each <tt>simplet_layer_t</tt> contains an
        <a href="http://www.gdal.org/ogr/ogr_formats.html">OGR</a> compatible
        datasource string, and stores a list of <tt>simplet_filter_t</tt> instances.
        Layers define access to spatial storage either from physical files or
        databases. Each contains a list of <tt>simplet_filter_t</tt> structures.
      </li>
      <li>
        <tt>simplet_filter_t</tt>: A <tt>simplet_filter_t</tt> instance stores
        <a href="http://www.gdal.org/ogr/ogr_sql.html">ogrsql</a>
        to filter the data on its parent's <tt>simplet_layer_t</tt> datasource.
        Each filter contains a list of <tt>simplet_style_t</tt> structures.
      </li>
      <li>
        <tt>simplet_style_t</tt>: A <tt>simplet_style_t</tt> instance stores information
        on how to style and display each data row returned from filters.
      </li>
    </ul>

    <p>
      For a real-world example on how this all fits together, here is
      a demo that draws the map in the Simple Tiles logo:
    </p>
<pre>
#include &lt;simple-tiles/simple_tiles.h&gt;
#include &lt;simple-tiles/filter.h&gt;
#include &lt;simple-tiles/layer.h&gt;

int
main(){
  simplet_map_t *map = simplet_map_new();
  simplet_map_set_srs(map, "EPSG:3083");
  simplet_map_set_bgcolor(map, "#ffffff");
  simplet_map_set_bounds(map, -585080.885134, 6849466.721081, 4161303.603672, 9587780.816356);
  simplet_map_set_size(map, 423, 260);
  simplet_layer_t *layer = simplet_map_add_layer(map, "PG:dbname=simple_tiles_roads");
  simplet_filter_t *filter = simplet_layer_add_filter(layer, "select * from roads");
  simplet_filter_add_style(filter, "stroke", "#11111166");
  simplet_filter_add_style(filter, "line-join", "round");
  simplet_filter_add_style(filter, "weight", "0.1");

  simplet_map_render_to_png(map, "./out.png");
  simplet_map_free(map);
}
</pre>
    <p>
      Another example is the repo's <a href="https://github.com/propublica/simple-tiles/blob/master/test/api.c">test/api.c</a>
      file.
    </p>

    <h2 id="maps">Maps</h2>
    <p>
      The <tt>simplet_map_t</tt> structure is the root of the Simple Tiles heirarchy
      and has methods that set and get information on the final output.
    </p>

    <h4 id="simplet_map_new"><code>simplet_map_t* simplet_map_new()</code></h4>
    <p>
      Allocates and returns a pointer to a new instance of <tt>simplet_map_t</tt>.
      Returns <tt>NULL</tt> or the instance; the new instance should be freed
      with <tt>simplet_map_free</tt>.
    </p>

    <h4 id="simplet_map_free"><code>void simplet_map_free(simplet_map_t *map)</code></h4>
    <p>
      Deallocates the memory allocated for a particular <tt>simplet_map_t</tt>,
      and its child structures. This should be the only deallocation function
      you'll need.
    </p>

    <h4 id="simplet_map_set_srs"><code>simplet_status_t simplet_map_set_srs(simplet_map_t *map, const char *proj)</code></h4>
    <p>
      Creates and assigns a particular projection to the map you may use any
      projection string that <a href="http://www.gdal.org/ogr/classOGRSpatialReference.html#ec3c6a49533fe457ddc763d699ff8796">
      <tt>OGRSpatialReference::SetFromUserInput</tt></a> understands. Returns
      a <a href="#status"><tt>simplet_status_t</tt></a> object. If you set a
      new srs and you have set the map's bounds in a previous projection, they
      will be updated for you.
    </p>

    <h4 id="simplet_map_get_srs"><code>void simplet_map_get_srs(simplet_map_t *map, char **srs)</code></h4>
    <p>
      Sets <tt>srs</tt> to the <tt>map</tt>'s srs, will allocate space for <tt>srs</tt>
      and <tt>srs</tt> should be deallocated with <tt>free</tt>.
    </p>

    <h4 id="simplet_map_set_size"><code>simplet_status_t simplet_map_set_size(simplet_map_t *map, int width, int height)</code></h4>
    <p>
      Sets the physical size of the output image. For tile generation you'll want to use
      <tt>simplet_map_set_slippy</tt> to set this automatically for web mercator.
    </p>

    <h4 id="simplet_map_set_bounds"><code>simplet_status_t simplet_map_set_bounds(simplet_map_t *map, double maxx, double maxy, double minx, double miny)</code></h4>
    <p>
      Sets the boundary of the map in the current projection. Again, <tt>simplet_map_set_slippy</tt>
      is an easy way to set this for tiled maps.
    </p>

    <h4 id="simplet_map_set_slippy"><code>simplet_status_t simplet_map_set_slippy(simplet_map_t *map, unsigned int x, unsigned int y, unsigned int z)</code></h4>
    <p>
      Takes a series of google map tile coordinates and sets the bounds, projection
      width and height of the <tt>simplet_map_t</tt> instance accordingly.
    </p>

    <h4 id="simplet_map_set_bgcolor"><code>simplet_status_t simplet_map_set_bgcolor(simplet_map_t *map, const char *str)</code></h4>
    <p>
      Stores a copy of <tt>str</tt> as the map's background color in <tt>#ffffffAA</tt>
      format <tt>AA</tt> is the alpha index of the color.
    </p>

    <h4 id="simplet_map_get_bgcolor"><code>void simplet_map_get_bgcolor(simplet_map_t *map, char **str)</code></h4>
    <p>
      Stores a copy of the <tt>map</tt>'s background color in <tt>str</tt>. <tt>str</tt>
      is then owned by the caller and should be <tt>free</tt>'d.
    </p>

    <h4 id="simplet_map_add_layer"><code>simplet_layer_t* simplet_map_add_layer(simplet_map_t *map, const char *datastring)</code></h4>
    <p>
      Adds a layer to the maps layer's list. <tt>datastring</tt> represents a
      resource that is readable by <a href="http://www.gdal.org/ogr/ogr_formats.html">OGR</a>,
      and returns a <tt>simplet_layer_t</tt> which is owned by the <tt>map</tt>
      and will be freed when the map is. Returns <tt>NULL</tt> on failure.
    </p>

    <h4 id="simplet_map_add_layer_directly"><code>simplet_layer_t* simplet_map_add_layer_directly(simplet_map_t *map, simplet_layer_t *layer)</code></h4>
    <p>
      Add a layer object created by <tt>simplet_layer_new</tt> directly the
      <tt>map</tt>'s list of layers.
    </p>

    <h4 id="simplet_map_get_status"><code>simplet_status_t simplet_map_get_status(simplet_map_t *map)</code></h4>
    <p>
      Returns the current status of the <tt>map</tt> object. Status codes are:
<pre>
typedef enum {
  SIMPLET_OK = 0,    // OK
  SIMPLET_ERR,       // Generic error
  SIMPLET_OOM,       // Out of memory for allocation
  SIMPLET_CAIRO_ERR, // Cairo error
  SIMPLET_OGR_ERR,   // OGR Error
} simplet_status_t;
</pre>
    </p>

    <h4 id="simplet_map_status_to_string"><code>const char* simplet_map_status_to_string(simplet_map_t *map)</code></h4>
    <p>
      Returns a pointer to an internal english version of the <tt>map</tt>'s
      status. Useful for error reporting.
    </p>

    <h4 id="simplet_map_is_valid"><code>simplet_status_t simplet_map_is_valid(simplet_map_t *map)</code></h4>
    <p>
      Returns a <tt>simplet_status_t</tt> of the current state of the <tt>map</tt>
      that indicates if the requirements for successfully rendering the map are
      met. In other words, if a <tt>map</tt> has bounds, width and height, projection
      and at least one <tt>layer</tt>.
    </p>

    <h4 id="simplet_map_render_to_png"><code>void simplet_map_render_to_png(simplet_map_t *map, const char *path)</code></h4>
    <p>
      Renders a png to the <tt>path</tt> based on the specification defined in
      <tt>map</tt>. Layers are painted on the image in order of insertion, that
      is the oldest layers are drawn first.
    </p>

    <h4 id="simplet_map_render_to_stream"><code>void simplet_map_render_to_stream(simplet_map_t *map, void *stream, cairo_status_t (*cb)(void *closure, const unsigned char *data, unsigned int length))</code></h4>
    <p>
      Renders the <tt>map</tt> to a png stream by repeatedly calling the <tt>closure</tt>.
      The <tt>closure</tt> is a <a href="http://cairographics.org/manual/cairo-PNG-Support.html#cairo-write-func-t">
      <tt>cairo_write_func_t</tt></a> and must conform to that API.
    </p>

    <h4 id="simplet_map_set_buffer"><code>void simplet_map_set_buffer(simplet_map_t *map, double buffer)</code></h4>
    <p>
      Sets the buffer on the <tt>map</tt>. Buffers are a kind of overprinting
      where you can include more shapes in rendering in order to set type correctly.
      Michal Migurski has a good <a href="http://mike.teczno.com/notes/mapnik.html">post</a>
      on why this is useful.
    </p>

    <h4 id="simplet_map_get_buffer"><code>double simplet_map_get_buffer(simplet_map_t *map)</code></h4>
    <p>
      Returns the <tt>map</tt>'s buffer.
    </p>

    <h2 id="layers">Layers</h2>
    <p>
      Each layer maps to a OGR datasource, and contains a list of filters to
      run against that source.
    </p>

    <h4 id="simplet_layer_new"><code>simplet_layer_t* simplet_layer_new(const char *datastring)</code></h4>
    <p>
      Create a new <tt>simplet_layer_t</tt> returns <tt>NULL</tt> on failure.
    </p>

    <h4 id="simplet_layer_free"><code>void simplet_layer_free(simplet_layer_t *layer)</code></h4>
    <p>
      Deallocate the <tt>simplet_layer_t</tt>.
    </p>

    <h4 id="simplet_layer_set_source"><code>void simplet_layer_set_source(simplet_layer_t *layer, char *source)</code></h4>
    <p>
      Set the <tt>layer</tt>'s source attribute. <tt>source</tt> needs to be a
      string pointing to an OGR readable <a href="http://www.gdal.org/ogr/ogr_formats.html">resource</a>.
    </p>

    <h4 id="simplet_layer_get_source"><code>void simplet_layer_get_source(simplet_layer_t *layer, char **source)</code></h4>
    <p>
      Stores a copy of the <tt>layer</tt>'s in <tt>source</tt>, and allocates
      space for the copy. <tt>source</tt> should be freed when no longer needed.
    </p>

    <h2 id="filters">Filters</h2>
    <p>
      Each contains <a href="http://www.gdal.org/ogr/ogr_sql.html">OGR SQL</a>
      to filter the data in its parent layer. Like layers they are drawn in
      order on the map canvas.
    </p>

    <h2 id="styles">Styles</h2>

    <h2 id="demo">Demo</h2>

    <img src="http://tiles-b.propublica.org/redistricting-maps/tiles/LA/12/512/845/11.png">
    <p><em>Simple Tiles is a project of ProPublica.</em></p>
  </body>
</html>
